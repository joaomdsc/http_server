* 2020/12/17

** Simulating a large Centreon installation

*** Hosts

Hosts called srvlnxNNN and srvwinNNN
Notes on hosts: db_server (x4), backend (x4), web (x4), a total of 12 servers
Host aliases 
DB hosts: transac, warehouse, historical, logging (one for each server)

*** Services (functional)

DB services: fct_transac_NNN, fct_warehouse, fct_historical, fct_logging
4 db servers, 5 services per host

Backend services: core, pricing, historization, logging (x5 on each server)

web x5 services on each host

A total of 60 services

** Host and service generation

Create a template through the UI, then use import/export mechanisms to create
object. It's unclear at this point if I'll be able to simply edit object
definition files (maybe once they've been created with the host or service id).

Use the CLI for updating the configuration:

    1. Generate config files (from what ?)
    2. Check/validate config
    3. Copy config files (to /etc/centreon-engine ?)
       3.5 Can I edit the object definitions here ?
    4. Re-start monitoring engine
    
** Check functions

Checks on hosts/services return 0 (ok) by default. They read json files
status_hosts.json and status_services.json where a different state may be
requested, this allows us to dynamically force state changes.

** Centreon CLI

General form:

    centreon -u admin -p centreon -a ACTION -v 1

where ACTION can be one of:

    pollerlist	      list pollers
    pollergenerate    generate local configuration files
    pollertest	      test monitoring engine configuration of a poller
    cfgmove	      move monitoring engine configuration files
    pollerrestart     restart monitoring engine of a poller
    applycfg	      all (of the above) in one command

** Target

Cfgmove overwrites my local changes, they must come after (losing the benefit
of test). Alternatively, I need to be sure where the config files are first
generated, and make my changes there.

/var/cache/centreon/config/engine/1

1. Generate config file
2. Inject my local changes
3. Test
4. Move
5. Restart

I injected my local changes into /var/cache/centreon/config/engine/1/hosts.cfg,
then followed with points 3 to 5. My changes are in /etc/centreon-engine, but
not in the ui. And of course, when I do another generate, my changes are
overwritten. So this doesn't work.

What I don't know is, where is the real source ? When we do "generate config
file", where does it come from ? That's where I would need to change it.

** A different approach, let's try import/export

Put notes in a host and a service through the UI:
  srvlnx007: db_server warehouse linux
  Specific service check: fct_histo db_service

Confirmed: UI saves somewhere, and pollergenerate copies from somewhere to
/var/cache.

Exporting:

[root@centreon-central ~]# centreon -u admin -p centreon -e --select='HOST;srvlnx007' --filter-type='^(HOST|SERVICE)$'
HOST;ADD;srvlnx007;backend-server-03;127.0.0.1;;Central;
HOST;setparam;srvlnx007;check_command;base_host_alive
HOST;setparam;srvlnx007;check_period;24x7
[...]
HOST;setparam;srvlnx007;host_activate;1
HOST;setparam;srvlnx007;notes;db_server warehouse linux

SERVICE;ADD;srvlnx007;Specific service check;Joao-Template
SERVICE;setparam;srvlnx007;Specific service check;check_command;check_server
SERVICE;setparam;srvlnx007;Specific service check;service_is_volatile;2
[...]
SERVICE;setparam;srvlnx007;Specific service check;service_activate;1
SERVICE;setparam;srvlnx007;Specific service check;notes;fct_histo db_service

Import:

    centreon -u admin -p centreon -i import_file.txt

and it immediately appears in the UI. Question: do I still have to go through
all the steps (gen, check, move, restart) ?

** Files

The user running the checks is centreon-engine, his HOME directory is
/var/lib/centreon-engine. That's where we must store the status_server.json and
status_service.json files, and that's where the checks will write their logs,
check_server.log and check_service.log.

    /var/lib/centreon-engine:
    total used in directory 80 available 16279400
    drwxr-xr-x.  4 centreon-engine centreon-engine  4096 Dec 17 23:03 .
    drwxr-xr-x. 39 root            root             4096 Apr 20  2020 ..
    prw-rw-r--   1 centreon-engine centreon-engine     0 Dec 17 16:01 central-module-master-stats.json
    -rw-rw-r--   1 centreon-engine centreon-engine     8 Dec 17 16:01 central-module-master.unprocessed
    -rw-rw-r--   1 centreon-engine centreon-engine  7107 Dec 17 23:04 check_server.log
    -rw-rw-r--   1 centreon-engine centreon-engine 37337 Dec 17 23:04 check_service.log
    drwxrwxr-x.  2 centreon-engine centreon-engine  4096 Sep 26 19:04 rw
    -rw-r--r--   1 centreon-engine centreon-engine    82 Dec 17 23:03 status_server.json
    -rw-r--r--   1 centreon-engine centreon-engine    93 Dec 17 23:03 status_service.json
